<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zspt.blibli.main.mapper.CommentMapper">
    <resultMap id="commentResultMap" type="com.zspt.blibli.main.controller.vo.comment.CommentListVo">
        <id property="id" column="id"/> <!-- 评论ID -->
        <result property="content" column="content"/>
        <result property="likeCount" column="like_count"/>

        <!-- 用户信息关联 -->
        <association property="userInfo" javaType="com.zspt.blibli.main.controller.vo.comment.CommentUserInfo">
            <id property="id" column="user_id"/>       <!-- 用户ID -->
            <result property="nickName" column="user_nick_name"/> <!-- 用户昵称 -->
            <result property="signature" column="create_time"/> <!-- 评论时间 -->
        </association>

        <!-- 回复列表 -->
        <collection property="reply" ofType="com.zspt.blibli.main.controller.vo.comment.Reply" javaType="java.util.ArrayList">
            <id property="replyId" column="reply_id"/>
            <result property="pCommentId" column="pComment_id"/>
            <result property="commentId" column="comment_id"/>
            <result property="userId" column="reply_user_id"/>
            <result property="nickName" column="reply_nick_name"/>
            <result property="replyUserId" column="reply_to_user_id"/>
            <result property="replyNickName" column="reply_to_nick_name"/>
            <result property="replyContent" column="reply_content"/>
        </collection>
    </resultMap>
    <select id="getComment" resultMap="commentResultMap">
        SELECT
        c.id AS id,             -- 评论ID
        c.content AS content,
        c.like_count AS like_count,
        c.create_time AS create_time,

        -- 用户信息列（添加 u_ 前缀）
        c.user_id AS user_id,           -- 用户ID
        c.nick_name AS user_nick_name,  -- 用户昵称

        -- 回复列（添加 r_ 前缀）
        r.reply_id AS reply_id,
        r.pComment_id,
        r.comment_id AS comment_id,
        r.user_id AS reply_user_id,     -- 回复用户ID
        r.nick_name AS reply_nick_name, -- 回复用户昵称
        r.reply_user_id AS reply_to_user_id, -- 被回复用户ID
        r.reply_nick_name AS reply_to_nick_name, -- 被回复用户昵称
        r.reply_content AS reply_content,
        r.create_time AS reply_create_time
        FROM bli_comment c
        LEFT JOIN (
        SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY pComment_id ORDER BY create_time DESC) AS rn
        FROM bli_comment_reply
        ) r ON c.id = r.pComment_id AND r.rn &lt;= #{replyCount} -- 获取回复数量
        WHERE c.video_id = #{videoId}
        <if test="lastTime != null">
            AND c.create_time &lt; #{lastTime}
        </if>
        ORDER BY c.create_time DESC, c.id DESC
        LIMIT #{pageSize}
    </select>
</mapper>