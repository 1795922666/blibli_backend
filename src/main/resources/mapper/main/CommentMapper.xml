<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zspt.blibli.main.mapper.CommentMapper">
    <resultMap id="commentResultMap" type="com.zspt.blibli.main.controller.vo.comment.CommentListVo">
        <id property="id" column="id"/> <!-- 评论ID -->
        <result property="pCommentId" column="pComment_id"/>
        <result property="content" column="content"/>
        <result property="likeCount" column="like_count"/>
        <result property="replyCount" column="reply_count"/>
        <!-- 用户信息关联 -->
        <association property="userInfo" javaType="com.zspt.blibli.main.controller.vo.comment.CommentUserInfo">
            <id property="id" column="user_id"/>       <!-- 用户ID -->
            <result property="nickName" column="user_nick_name"/> <!-- 用户昵称 -->
            <result property="signature" column="create_time"/> <!-- 评论时间 -->
        </association>

        <!-- 回复列表 -->
        <collection property="reply" ofType="com.zspt.blibli.main.controller.vo.comment.Reply" javaType="java.util.ArrayList">
            <id property="replyId" column="reply_id"/>
            <result property="pCommentId" column="spComment_id"/>
            <result property="commentId" column="comment_id"/>
            <result property="userId" column="reply_user_id"/>
            <result property="nickName" column="reply_nick_name"/>
            <result property="replyUserId" column="reply_to_user_id"/>
            <result property="replyNickName" column="reply_to_nick_name"/>
            <result property="replyContent" column="reply_content"/>
            <result property="replyUpdateTime" column="reply_update_time"/>
        </collection>
    </resultMap>

    <select id="getComment" resultMap="commentResultMap">
        SELECT
        c.id AS id,             -- 评论ID
        c.pComment_id AS  pComment_id,
        c.content AS content,
        c.like_count AS like_count,
        c.reply_count AS  reply_count,
        c.create_time AS create_time,

        -- 用户信息列（添加 u_ 前缀）
        c.user_id AS user_id,           -- 用户ID
        c.nick_name AS user_nick_name,  -- 用户昵称

        -- 回复列（添加 r_ 前缀）
        r.reply_id AS reply_id,
        r.pComment_id As spComment_id,
        r.comment_id AS comment_id,
        r.user_id AS reply_user_id,     -- 回复用户ID
        r.nick_name AS reply_nick_name, -- 回复用户昵称
        r.reply_user_id AS reply_to_user_id, -- 被回复用户ID
        r.reply_nick_name AS reply_to_nick_name, -- 被回复用户昵称
        r.reply_content AS reply_content,
        r.update_time AS reply_update_time
        FROM bli_comment c
        LEFT JOIN (
        SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY pComment_id ORDER BY create_time DESC) AS rn
        FROM bli_comment_reply
        ) r ON c.id = r.pComment_id AND r.rn &lt;= #{replyCount} -- 获取回复数量
        WHERE c.video_id = #{videoId}
        AND c.status !=0
        <if test="lastTime != null">
            AND c.create_time &lt; #{lastTime}
        </if>
        ORDER BY c.create_time DESC, c.id DESC
        LIMIT #{pageSize}
    </select>

    <resultMap id="CommentAuditResultMap" type="com.zspt.blibli.admin.controller.vo.Comment.CommentAuditVo">
        <!-- 公共字段 -->
        <id column="comment_id" property="comment_id"/>
        <result column="level" property="level"/>
        <result column="pUser_id" property="pUserId"/>          <!-- 一级评论：userId -->
        <result column="pNick_name" property="pNickName"/>      <!-- 一级评论：nickName -->
        <result column="userId" property="userId"/>           <!-- 二级评论：userid -->
        <result column="nickName" property="nickName"/>      <!-- 二级评论：nick_name -->
        <result column="content" property="content"/>
        <result column="create_time" property="create_time"/>
        <result column="video" property="video"/>
        <result column="status" property="status"/>

        <!-- 二级评论专属字段 -->
        <result column="reply_user_id" property="reply_user_id"/>
        <result column="reply_nick_name" property="reply_nick_name"/>

        <!-- 父评论嵌套信息 -->
        <association property="parent_info" javaType="com.zspt.blibli.admin.controller.vo.Comment.ParentInfo">
            <result column="parent_comment_id" property="parent_comment_id"/>
            <result column="parent_uid" property="parent_uid"/>
            <result column="parent_content" property="parent_content"/>
        </association>
    </resultMap>

    <select id="selectAuditCommentWithSpecifiedFormat" resultMap="CommentAuditResultMap">
        SELECT
        c.id AS comment_id,
        1 AS level,
        c.user_id AS pUser_id,
        c.nick_name AS pNick_name,
        NULL AS userid,
        NULL AS nickname,
        c.content AS content,
        c.create_time AS create_time,
        CONCAT('视频《', COALESCE(v.title, '未知视频'), '》') AS video, -- 无视频名时显示“未知视频”
        c.status AS status,
        NULL AS reply_user_id,
        NULL AS reply_nick_name,
        NULL AS parent_comment_id,
        NULL AS parent_uid,
        NULL AS parent_content
        FROM bli_comment c
        LEFT JOIN bli_videos v ON c.video_id = v.video_id -- 关联视频表 bli_videos
        WHERE c.status IN (0, 3)
        <if test="videoId != null">
            AND c.video_id = #{videoId}
        </if>

        UNION ALL

        -- 2. 二级评论（status=0/4）- 关联 bli_videos 表获取真实视频名
        SELECT
        cr.reply_id AS comment_id, -- 关联的一级评论ID
        2 AS level,
        NULL AS user_id,
        NULL AS nick_name,
        cr.user_id AS userId,
        cr.nick_name AS nickName,
        cr.reply_content AS content, -- 二级评论内容：reply_content
        cr.create_time AS create_time,
        CONCAT('视频《', COALESCE(v.title, '未知视频'), '》') AS video, -- 无视频名时显示“未知视频”
        cr.status AS status,
        cr.reply_user_id AS reply_user_id,
        cr.reply_nick_name AS reply_nick_name,
        cr.pComment_id AS parent_comment_id, -- 父评论ID：pComment_id
        pc.user_id AS parent_uid, -- 父评论发布人ID
        pc.content AS parent_content -- 父评论内容
        FROM bli_comment_reply cr
        LEFT JOIN bli_comment pc ON cr.pComment_id = pc.id -- 关联一级评论取父信息
        LEFT JOIN bli_comment main_c ON cr.comment_id = main_c.id -- 关联一级评论取video_id
        LEFT JOIN bli_videos v ON main_c.video_id = v.video_id -- 关联视频表 bli_videos
        WHERE cr.status IN (0, 3)
        <if test="videoId != null">
            AND main_c.video_id = #{videoId}
        </if>

        ORDER BY create_time DESC
    </select>
</mapper>